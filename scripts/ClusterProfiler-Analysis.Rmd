---
title: "DC pathway analysis - ClusterProfiler"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 


*Prepare Data from the Marker-anlysis in your Seurat-object*

```{r, }
#load Seurat-object
readRDS("Path/to/RDS-file")

#Run Marker analyis if not happened or save and load tables with DEG markers of individual clusters

#Load gene-table (Biomart created , with entrez-IDs added "genes-annotation-entrez.tab")

#1) add the ensembl-IDs as extra column in marker-table
dc.mus.C0.m$ensembl_gene_id <- rownames(dc.mus.C0.m)
#2) Use dplyr packges function to add the entrez IDs/ whole gene table to the expressed markers based on the ensembl_ID and retain only rows that are present in both Data-frames:

C0.dc <- dplyr::inner_join(dc.mus.C0.m, genes.table, by = "ensembl_gene_id")


head(C0.dc)
head(dc.mus.C0.m)


```

```{r, load packages}

library(Seurat)
library(clusterProfiler)
library(DOSE)
library(enrichplot)
library(ggplot2)

```
*Possible problem: some ENSEMBL-IDs don't seem to have an Entrez-gene ID and therefore are dpeicted as NA in the data - possibly try to run everything wit only ENSEMBL-IDs*

```{r, topGO analysis}

#Subset the seurat objects according to the identified clusters 

cluster0.GO <- SubsetData(se.dc.mus.e, ident.use = 0)
cluster1.GO <- SubsetData(se.dc.mus.e, ident.use = 1)
cluster2.GO <- SubsetData(se.dc.mus.e, ident.use = 2)
cluster3.GO <- SubsetData(se.dc.mus.e, ident.use = 3)
cluster4.GO <- SubsetData(se.dc.mus.e, ident.use = 4)
cluster5.GO <- SubsetData(se.dc.mus.e, ident.use = 5)
cluster6.GO <- SubsetData(se.dc.mus.e, ident.use = 6)
cluster7.GO <- SubsetData(se.dc.mus.e, ident.use = 7)
cluster8.GO <- SubsetData(se.dc.mus.e, ident.use = 8)

#extract the expression data 
expr0 <- cluster0.GO@assays$SCT@data
expr1 <- cluster1.GO@assays$SCT@data
expr2 <- cluster2.GO@assays$SCT@data
expr3 <- cluster3.GO@assays$SCT@data
expr4 <- cluster4.GO@assays$SCT@data
expr5 <- cluster5.GO@assays$SCT@data
expr6 <- cluster6.GO@assays$SCT@data
expr7 <- cluster7.GO@assays$SCT@data
expr8 <- cluster8.GO@assays$SCT@data

```

*Now that we have the expression data we can set some thresholds on how to define which genes we are interested in - the cutoff we are setting here now is that we only want to include genes that are expressed (expression-value > 0) and that are present in >75% of the cells in the reseptive subset*

```{r, selection of raw expression data for expression values}

n.gt.0 <- apply(expr0, 1, function(x)length(which(x > 0)))
expressed.genes.0 <- rownames(expr0)[which(n.gt.0/ncol(expr0) >= 0.75)]
all.genes.0 <- rownames(expr0)

n.gt.1 <- apply(expr1, 1, function(x)length(which(x > 0)))
expressed.genes.1 <- rownames(expr1)[which(n.gt.1/ncol(expr1) >= 0.75)]
all.genes.1 <- rownames(expr1)

n.gt.2 <- apply(expr2, 1, function(x)length(which(x > 0)))
expressed.genes.2 <- rownames(expr2)[which(n.gt.2/ncol(expr2) >= 0.75)]
all.genes.2 <- rownames(expr2)

n.gt.3 <- apply(expr3, 1, function(x)length(which(x > 0)))
expressed.genes.3 <- rownames(expr3)[which(n.gt.3/ncol(expr3) >= 0.75)]
all.genes.3 <- rownames(expr3)

n.gt.4 <- apply(expr4, 1, function(x)length(which(x > 0)))
expressed.genes.4 <- rownames(expr4)[which(n.gt.4/ncol(expr4) >= 0.75)]
all.genes.4 <- rownames(expr4)

n.gt.5 <- apply(expr5, 1, function(x)length(which(x > 0)))
expressed.genes.5 <- rownames(expr5)[which(n.gt.5/ncol(expr5) >= 0.75)]
all.genes.5 <- rownames(expr5)

n.gt.6 <- apply(expr6, 1, function(x)length(which(x > 0)))
expressed.genes.6 <- rownames(expr6)[which(n.gt.6/ncol(expr6) >= 0.75)]
all.genes.6 <- rownames(expr6)

n.gt.7 <- apply(expr7, 1, function(x)length(which(x > 0)))
expressed.genes.7 <- rownames(expr7)[which(n.gt.7/ncol(expr7) >= 0.75)]
all.genes.7 <- rownames(expr7)

n.gt.8 <- apply(expr8, 1, function(x)length(which(x > 0)))
expressed.genes.8 <- rownames(expr8)[which(n.gt.8/ncol(expr8) >= 0.75)]
all.genes.8 <- rownames(expr8)

#define geneList as 1 if gene is in expressed.genes, 0 otherwise - all the steps before this step can also be done with the marker-gene outputs from the marker gene analysis

##Clean up code by working with lists! (also makes it easier later when working with a different number of clusters or if the number of clusters change!)

##Make gene-lists for GO-term-analysis

geneList0 <- ifelse(all.genes.0 %in% expressed.genes.0, 1, 0)
geneList1 <- ifelse(all.genes.1 %in% expressed.genes.1, 1, 0)
geneList2 <- ifelse(all.genes.2 %in% expressed.genes.2, 1, 0)
geneList3 <- ifelse(all.genes.3 %in% expressed.genes.3, 1, 0)
geneList4 <- ifelse(all.genes.4 %in% expressed.genes.4, 1, 0)
geneList5 <- ifelse(all.genes.5 %in% expressed.genes.5, 1, 0)
geneList6 <- ifelse(all.genes.6 %in% expressed.genes.6, 1, 0)
geneList7 <- ifelse(all.genes.7 %in% expressed.genes.7, 1, 0)
geneList8 <- ifelse(all.genes.8 %in% expressed.genes.8, 1, 0)

names(geneList0) <- all.genes.0
names(geneList1) <- all.genes.1
names(geneList2) <- all.genes.2
names(geneList3) <- all.genes.3
names(geneList4) <- all.genes.4
names(geneList5) <- all.genes.5
names(geneList6) <- all.genes.6
names(geneList7) <- all.genes.7
names(geneList8) <- all.genes.8

```

```{r, create geneLists for GO from markers and respectce p-values in seuratobject}


geneList0.m <- dc.mus.C0.m[,2]
names(geneList0.m) <- as.character(rownames(dc.mus.C0.m))
geneList0.m <- sort(geneList0.m, decreasing = T)

head(geneList0.m)

#Define foldchange greater than 2 as DEGs (only as an example here)
DEGgeneC0 <- names(geneList0.m)[abs(geneList0.m)>2]
head(DEGgeneC0)





```

```{r, create topGO objects and run fisher tests}

#For annotation use the org database for mouse (org.Mm.eg.db)
#Install that first and load it in the environment as a package (see above)

GOdata.0 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneList0,
    geneSelectionFun = function(x)(x == 1), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")


GOdata.1 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneList1,
    geneSelectionFun = function(x)(x == 1), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")

GOdata.2 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneList2,
    geneSelectionFun = function(x)(x == 1), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")
GOdata.3 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneList3,
    geneSelectionFun = function(x)(x == 1), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")
GOdata.4 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneList4,
    geneSelectionFun = function(x)(x == 1), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")
GOdata.5 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneList5,
    geneSelectionFun = function(x)(x == 1), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")

GOdata.6 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneList6,
    geneSelectionFun = function(x)(x == 1), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")


GOdata.7 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneList7,
    geneSelectionFun = function(x)(x == 1), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")


GOdata.8 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneList8,
    geneSelectionFun = function(x)(x == 1), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")


# Test for enrichment using Fisher's Exact Test
resultFisher.0 <- runTest(GOdata.0, algorithm = "elim", statistic = "fisher")
resultFisher.1 <- runTest(GOdata.1, algorithm = "elim", statistic = "fisher")
resultFisher.2 <- runTest(GOdata.2, algorithm = "elim", statistic = "fisher")
resultFisher.3 <- runTest(GOdata.3, algorithm = "elim", statistic = "fisher")
resultFisher.4 <- runTest(GOdata.3, algorithm = "elim", statistic = "fisher")
resultFisher.5 <- runTest(GOdata.3, algorithm = "elim", statistic = "fisher")
resultFisher.6 <- runTest(GOdata.3, algorithm = "elim", statistic = "fisher")
resultFisher.7 <- runTest(GOdata.3, algorithm = "elim", statistic = "fisher")
resultFisher.8 <- runTest(GOdata.3, algorithm = "elim", statistic = "fisher")

GO.table0 <- GenTable(GOdata.0, Fisher = resultFisher.0, topNodes = 20, numChar = 60)
GO.table1 <- GenTable(GOdata.1, Fisher = resultFisher.1, topNodes = 20, numChar = 60)
GO.table2 <- GenTable(GOdata.2, Fisher = resultFisher.2, topNodes = 20, numChar = 60)
GO.table3 <- GenTable(GOdata.3, Fisher = resultFisher.3, topNodes = 20, numChar = 60)
GO.table4 <- GenTable(GOdata.4, Fisher = resultFisher.4, topNodes = 20, numChar = 60)
GO.table5 <- GenTable(GOdata.5, Fisher = resultFisher.5, topNodes = 20, numChar = 60)
GO.table6 <- GenTable(GOdata.6, Fisher = resultFisher.6, topNodes = 20, numChar = 60)
GO.table7 <- GenTable(GOdata.7, Fisher = resultFisher.7, topNodes = 20, numChar = 60)
GO.table8 <- GenTable(GOdata.8, Fisher = resultFisher.8, topNodes = 20, numChar = 60)

GO.table8

##Formatting of the GO-table:

GO.table0$Fisher <- as.numeric(GO.table0$Fisher)
GO.table0 <- GO.table0[GO.table0$Fisher<0.05,]
GO.table0 <- GO.table0[,c("GO.ID","Term", "Fisher")]
GO.table0$Term <- gsub("[a-z]*\\.\\.\\.$","", GO.table0$Term)
GO.table0$Term <- paste(GO.table0$GO.ID, GO.table0$Term, sep=",")
GO.table0$Term <- factor(GO.table0$Term, levels = rev(GO.table0$Term))

```


```{r, make geneLists as templates for topGO analyis}

#Cluster3
geneListC3 <- C3.dc[,2]
names(geneListC3) <- C3.dc[,7]
geneListC3 <- sort(geneListC3, decreasing = T)
head(geneListC3)

#Define foldchange greater than 2 as DEGs (only as an example here - but we will also have that in the function later on)
DEGgeneC3 <- names(geneListC3)[abs(geneListC3)>2]
head(DEGgeneC3)

#Cluster6 
geneListC6 <- C6.dc[,2]
names(geneListC6) <- C6.dc[,7]
geneListC6 <- sort(geneListC6, decreasing = T)
head(geneListC6)

#Define foldchange greater than 2 as DEGs (only as an example here - but we will also have that in the function later on)
DEGgeneC6 <- names(geneListC6)[abs(geneListC6)>2]
head(DEGgeneC6)

#DEG12h 

DEG12h <- DEG12h.dc$avg_logFC
names(DEG12h) <- DEG12h.dc$ensembl_gene_id
DEG12h <- sort(DEG12h, decreasing = T)
head(DEG12h)

#Define foldchange greater than 2 as DEGs (only as an example here - but we will also have that in the function later on)
DEGgeneC3C6 <- names(DEG12h)[abs(DEG12h)>2]
head(DEGgeneC3C6)

```



```{r, create topGO object wih Marker genes of cluster}

GOdata.0 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneList0.m,
    geneSelectionFun = function(x)(x >= 2), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")

resultFisher.0 <- runTest(GOdata.0, algorithm = "elim", statistic = "fisher")
GO.table0 <- GenTable(GOdata.0, Fisher = resultFisher.0, topNodes = 20, numChar = 60)
GO.table0

#Formatting
GO.table0$Fisher <- as.numeric(GO.table0$Fisher)
GO.table0 <- GO.table0[GO.table0$Fisher<0.05,]
GO.table0 <- GO.table0[,c("GO.ID","Term", "Fisher")]
GO.table0$Term <- gsub("[a-z]*\\.\\.\\.$","", GO.table0$Term)
GO.table0$Term <- paste(GO.table0$GO.ID, GO.table0$Term, sep=",")
GO.table0$Term <- factor(GO.table0$Term, levels = rev(GO.table0$Term))

# Cluster 3

GOdata.C3 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneListC3,
    geneSelectionFun = function(x)(x >= 2), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")

resultFisher.3 <- runTest(GOdata.C3, algorithm = "elim", statistic = "fisher")
GOtable.C3 <- GenTable(GOdata.C3, Fisher = resultFisher.3, topNodes = 20, numChar = 60)
GOtable.C3

#Formatting
GOtable.C3$Fisher <- as.numeric(GOtable.C3$Fisher)
GOtable.C3 <- GOtable.C3[GOtable.C3$Fisher<0.05,]
GOtable.C3 <- GOtable.C3[,c("GO.ID","Term", "Fisher")]
GOtable.C3$Term <- gsub("[a-z]*\\.\\.\\.$","", GOtable.C3$Term)
GOtable.C3$Term <- paste(GOtable.C3$GO.ID, GOtable.C3$Term, sep=",")
GOtable.C3$Term <- factor(GOtable.C3$Term, levels = rev(GOtable.C3$Term))


# Cluster 6

GOData.C6 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = geneListC6,
    geneSelectionFun = function(x)(x >= 2), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")

resultFisher.6 <- runTest(GOData.C6, algorithm = "elim", statistic = "fisher")
GOtable.C6 <- GenTable(GOData.C6, Fisher = resultFisher.6, topNodes = 20, numChar = 60)
GOtable.C6

#Formatting
GOtable.C6$Fisher <- as.numeric(GOtable.C6$Fisher)
GOtable.C6 <- GOtable.C6[GOtable.C6$Fisher<0.05,]
GOtable.C6 <- GOtable.C6[,c("GO.ID","Term", "Fisher")]
GOtable.C6$Term <- gsub("[a-z]*\\.\\.\\.$","", GOtable.C6$Term)
GOtable.C6$Term <- paste(GOtable.C6$GO.ID, GOtable.C6$Term, sep=",")
GOtable.C6$Term <- factor(GOtable.C6$Term, levels = rev(GOtable.C6$Term))


#DEG, cluster 3 versus cluster 6 

GOData.C3C6 <- new("topGOdata",
    ontology = "BP", # use biological process ontology
    allGenes = DEG12h,
    geneSelectionFun = function(x)(x >= 2), 
          annot = annFUN.org, mapping = "org.Mm.eg.db", ID = "Ensembl")

resultFisher.C3C4 <- runTest(GOData.C3C6 , algorithm = "elim", statistic = "fisher")
GOtable.C3C6  <- GenTable(GOData.C3C6 , Fisher = resultFisher.C3C4, topNodes = 20, numChar = 60)
GOtable.C3C6 

#Formatting

GOtable.C3C6 $Fisher <- as.numeric(GOtable.C3C6 $Fisher)
GOtable.C3C6  <- GOtable.C3C6 [GOtable.C3C6 $Fisher<0.05,]
GOtable.C3C6  <- GOtable.C3C6 [,c("GO.ID","Term", "Fisher")]
GOtable.C3C6 $Term <- gsub("[a-z]*\\.\\.\\.$","", GOtable.C3C6 $Term)
GOtable.C3C6 $Term <- paste(GOtable.C3C6 $GO.ID, GOtable.C3C6 $Term, sep=",")
GOtable.C3C6 $Term <- factor(GOtable.C3C6 $Term, levels = rev(GOtable.C3C6 $Term))

```

```{r, visualization}

p.0.1 <- ggplot(GO.table0, aes(x=Term, y=-log10(Fisher))) +
  geom_point(aes(size =-log10(Fisher), fill = GO.ID), alpha = 1, shape = 21) +
  xlab("Biological process") +
  ylab("Enrichment") +
  ggtitle("GO enrichment in Cluster 0") +
  scale_y_continuous() +
  theme_bw(base_size=15) +
  theme(
    legend.position='none',
    legend.background=element_rect(),
    plot.title=element_text(angle=0, size=10, face="bold", vjust=1),
    axis.text.x=element_text(angle=0, size=10, face="bold", hjust=1.10),
    axis.text.y=element_text(angle=0, size=10, face="bold", vjust=0.5),
    axis.title=element_text(size=10, face="bold"),
    legend.key=element_blank(),     #removes the border
    legend.key.size=unit(1.5, "cm"),      #Sets overall area/size of the legend
    legend.text=element_text(size=10),    #Text size
    title=element_text(size=18)) +
  guides(colour=guide_legend(override.aes=list(size=2))) + 
  coord_flip() 

p.0
p.0.1

```

```{r, visualize the different GO-term analysis}

p.C3 <- ggplot(GOtable.C3, aes(x=Term, y=-log10(Fisher))) +
  geom_point(aes(size =-log10(Fisher), fill = GO.ID), alpha = 1, shape = 21) +
  xlab("Biological process") +
  ylab("Enrichment") +
  ggtitle("GO enrichment in Cluster 3") +
  scale_y_continuous(limits = c(1,3), breaks = c(1,1.5,2,2.5,3)) +
  theme_bw(base_size=15) +
  theme(
    legend.position='none',
    legend.background=element_rect(),
    plot.title=element_text(angle=0, size=10, face="bold", vjust=1),
    axis.text.x=element_text(angle=0, size=10, face="bold", hjust=1.10),
    axis.text.y=element_text(angle=0, size=10, face="bold", vjust=0.5),
    axis.title=element_text(size=10, face="bold"),
    legend.key=element_blank(),     #removes the border
    legend.key.size=unit(1.5, "cm"),      #Sets overall area/size of the legend
    legend.text=element_text(size=10),    #Text size
    title=element_text(size=18)) +
  guides(colour=guide_legend(override.aes=list(size=2))) + 
  coord_flip() 

p.C6 <- ggplot(GOtable.C6, aes(x=Term, y=-log10(Fisher))) +
  geom_point(aes(size =-log10(Fisher), fill = GO.ID), alpha = 1, shape = 21) +
  xlab("Biological process") +
  ylab("Enrichment") +
  ggtitle("GO enrichment in Cluster 6") +
  scale_y_continuous(limits = c(1,4), breaks = c(1,1.5,2,2.5,3,3.5,4)) +
  theme_bw(base_size=15) +
  theme(
    legend.position='none',
    legend.background=element_rect(),
    plot.title=element_text(angle=0, size=10, face="bold", vjust=1),
    axis.text.x=element_text(angle=0, size=10, face="bold", hjust=1.10),
    axis.text.y=element_text(angle=0, size=10, face="bold", vjust=0.5),
    axis.title=element_text(size=10, face="bold"),
    legend.key=element_blank(),     #removes the border
    legend.key.size=unit(1.5, "cm"),      #Sets overall area/size of the legend
    legend.text=element_text(size=10),    #Text size
    title=element_text(size=18)) +
  guides(colour=guide_legend(override.aes=list(size=2))) + 
  coord_flip() 

##Not super sure if this makes sense at all - have a closer look at it! 

p.C3C6 <- ggplot(GOtable.C3C6, aes(x=Term, y=-log10(Fisher))) +
  geom_point(aes(size =-log10(Fisher), fill = GO.ID), alpha = 1, shape = 21) +
  xlab("Biological process") +
  ylab("Enrichment") +
  ggtitle("GO enrichment of DEGs between C3 and C6") +
  scale_y_continuous() +
  theme_bw(base_size=15) +
  theme(
    legend.position='none',
    legend.background=element_rect(),
    plot.title=element_text(angle=0, size=10, face="bold", vjust=1),
    axis.text.x=element_text(angle=0, size=10, face="bold", hjust=1.10),
    axis.text.y=element_text(angle=0, size=10, face="bold", vjust=0.5),
    axis.title=element_text(size=10, face="bold"),
    legend.key=element_blank(),     #removes the border
    legend.key.size=unit(1.5, "cm"),      #Sets overall area/size of the legend
    legend.text=element_text(size=10),    #Text size
    title=element_text(size=18)) +
  guides(colour=guide_legend(override.aes=list(size=2))) + 
  coord_flip() 

p.GO.C.6 <- cowplot::plot_grid(p.C3,NULL,p.C6, rel_widths = c(1,0.3,1), ncol= 3)


png(filename = "~/Desktop/TG-DC-Analysis/Results-200507-FiguresAndTables/GO-term-analysis.png", width = 45, height = 15, res = 300, units = "cm") #Units are pixels by default
print(p.GO.C.6)
dev.off()
```